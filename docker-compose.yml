version: "3"
services:

    influxdb:
        container_name: influxdb
        image: influxdb:2.0.4
        restart: always
        ports:
        - 8086:8086
        env_file:
            - './influxdb/env.influxdb'
            - './.env'
        volumes:
            - type: "volume"
              source: influxdb2-data
              target: /root/.influxdbv2

    grafana:
        container_name: grafana
        image: grafana/grafana:7.5.3
        restart: always
        depends_on:
          - influxdb
        profiles:
          - post_influx
        env_file:
          - './grafana/env.grafana'
          - './.env'
        ports:
        - 3000:3000
        volumes:
            - grafana-data:/var/lib/grafana
            - ./grafana/logs:/var/log/grafana
            - ./grafana/plugins:/var/lib/grafana/plugins
            - ./grafana/grafana.ini:/etc/grafana/grafana.ini
            - ./grafana/datasources/influxdb.yml:/etc/grafana/provisioning/datasources/influxdb.yml

    telegraf:
        container_name: telegraf
        image: telegraf:1.18.0
        restart: always
        depends_on:
          - influxdb
        profiles:
          - post_influx
        env_file:
            - './telegraf/env.telegraf'
            - './.env'
        environment:
            HOST_PROC: /rootfs/proc
            HOST_SYS: /rootfs/sys
            HOST_ETC: /rootfs/etc
        volumes:
            - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /sys:/rootfs/sys:ro
            - /proc:/rootfs/proc:ro
            - /etc:/rootfs/etc:ro

    caddy:
        image: caddy:2.3.0-alpine
        restart: unless-stopped
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - $PWD/caddy/Caddyfile:/etc/caddy/Caddyfile
          - metrics-caddy-data:/data
          - metrics-caddy-config:/config

volumes:
  influxdb2-data:
    external: true
    name: influxdb2-data
  grafana-data:
    external: true
    name: grafana-data
  metrics-caddy-data:
    external: true
    name: metrics-caddy-data
  metrics-caddy-config:
    external: true
    name: metrics-caddy-config
